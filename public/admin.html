<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Hany 부동산 관리자</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "Noto Sans KR", -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
    }
    body {
      min-height: 100vh;
      background: #f3f4f6;
      padding: 16px 12px 40px;
      display: flex;
      justify-content: center;
      color: #111827;
    }
    .app {
      width: 100%;
      max-width: 900px;
    }

    h1 {
      font-size: 22px;
      font-weight: 800;
      margin-bottom: 4px;
    }
    .subtitle {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 14px;
    }

    .grid {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1fr);
      gap: 12px;
    }
    @media (max-width: 720px) {
      .grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: #ffffff;
      border-radius: 16px;
      padding: 12px 12px 14px;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.08);
      border: 1px solid #e5e7eb;
    }
    .card-title {
      font-size: 15px;
      font-weight: 700;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .card-title span {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      border-radius: 999px;
      background: #eff6ff;
      color: #2563eb;
      font-size: 11px;
    }
    .help-text {
      font-size: 11px;
      color: #6b7280;
      margin-top: 4px;
    }

    /* 폼 */
    .form-row {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 8px;
      font-size: 13px;
    }
    .form-row label {
      font-size: 12px;
      color: #374151;
      font-weight: 600;
    }
    .form-row input,
    .form-row textarea {
      border-radius: 10px;
      border: 1px solid #d1d5db;
      padding: 7px 9px;
      font-size: 13px;
      outline: none;
    }
    .form-row textarea {
      resize: vertical;
      min-height: 60px;
    }
    .tag-group {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 2px;
    }
    .tag-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid #d4d4d8;
      font-size: 11px;
    }
    .tag-chip input {
      margin: 0;
    }

    .btn-primary,
    .btn-secondary,
    .btn-danger {
      border-radius: 999px;
      border: none;
      padding: 7px 12px;
      font-size: 12px;
      cursor: pointer;
      white-space: nowrap;
    }
    .btn-primary {
      background: linear-gradient(135deg, #38bdf8, #0ea5e9);
      color: #ffffff;
      box-shadow: 0 6px 14px rgba(56, 189, 248, 0.35);
    }
    .btn-secondary {
      background: #f3f4f6;
      color: #374151;
      border: 1px solid #e5e7eb;
    }
    .btn-danger {
      background: #fee2e2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }

    /* 리스트 */
    .list {
      margin-top: 6px;
      max-height: 280px;
      overflow-y: auto;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      padding: 4px 0;
    }
    .list-item {
      padding: 6px 10px;
      border-bottom: 1px solid #f3f4f6;
      font-size: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .list-item:last-child {
      border-bottom: none;
    }
    .list-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .list-title {
      font-weight: 600;
      color: #111827;
    }
    .list-sub {
      font-size: 11px;
      color: #6b7280;
    }

    .badge-tag {
      display: inline-flex;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 10px;
      background: #eef2ff;
      color: #4f46e5;
      margin-left: 4px;
    }

    .json-box {
      width: 100%;
      min-height: 120px;
      font-size: 11px;
      padding: 8px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      white-space: pre-wrap;
    }

    /* 회원 리스트 */
    .user-list {
      margin-top: 6px;
      border-top: 1px solid #eee;
      padding-top: 6px;
      max-height: 260px;
      overflow-y: auto;
    }
    .user-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 0;
      border-bottom: 1px solid #f1f1f1;
      font-size: 12px;
    }
    .user-item:last-child {
      border-bottom: none;
    }
    .user-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .user-name-row {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .user-name {
      font-weight: 600;
      color: #111827;
    }
    .user-role-badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #eef4ff;
      color: #1d4ed8;
    }
    .user-meta {
      font-size: 11px;
      color: #6b7280;
    }
    .current-indicator {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.25);
      margin-right: 4px;
    }
    .user-item-right {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      color: #16a34a;
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>Hany 부동산 관리자</h1>
    <div class="subtitle">매물 등록 / 관리 및 회원 정보를 확인할 수 있습니다.</div>

    <div class="grid">
      <!-- 왼쪽: 매물 등록 / 회원 보기 -->
      <div class="left">
        <!-- 새 매물 등록 -->
        <div class="card">
          <div class="card-title">
            <span>1</span>
            새 매물 등록
          </div>

          <div class="form-row">
            <label>제목</label>
            <input id="title" placeholder="예: 푸미흥 2룸 오피스텔" />
          </div>

          <div class="form-row">
            <label>가격</label>
            <input id="price" placeholder="예: 보증금 1,000 / 월세 900" />
          </div>

          <div class="form-row">
            <label>위치</label>
            <input id="location" placeholder="예: 호치민 푸미흥, 7군" />
          </div>

          <div class="form-row">
            <label>구글 지도 링크</label>
            <div style="display:flex; gap:6px; align-items:center;">
              <input
                id="mapUrl"
                style="flex:1;"
                placeholder="https://maps.app.goo.gl/... 또는 https://maps.google.com/..."
              />
              <button class="btn-secondary" type="button" id="resolveMapBtn" style="white-space:nowrap;">
                주소변환
              </button>
            </div>
            <div class="help-text">
              구글 지도 앱/웹에서 위치 공유 → 링크 복사 후 붙여넣기 (짧은 주소도 변환 가능)
            </div>
          </div>

          <div class="form-row">
            <label>설명</label>
            <textarea id="desc" placeholder="예: 보행가 도보 5분, 관리비 포함, 반려견 가능 등"></textarea>
          </div>

          <div class="form-row">
            <label>태그</label>
            <div class="tag-group">
              <label class="tag-chip"><input type="checkbox" value="푸미흥" /> 푸미흥</label>
              <label class="tag-chip"><input type="checkbox" value="7군" /> 7군</label>
              <label class="tag-chip"><input type="checkbox" value="1룸" /> 1룸</label>
              <label class="tag-chip"><input type="checkbox" value="2룸" /> 2룸</label>
              <label class="tag-chip"><input type="checkbox" value="오피스텔" /> 오피스텔</label>
              <label class="tag-chip"><input type="checkbox" value="전세" /> 전세</label>
              <label class="tag-chip"><input type="checkbox" value="월세" /> 월세</label>
            </div>
            <div class="help-text">
              해당 매물에 어울리는 태그를 선택해주세요.
            </div>
          </div>

          <div class="form-row">
            <label>이미지 (여러 장 선택 가능)</label>
            <input id="images" type="file" accept="image/*" multiple />
            <div class="help-text">
              모바일 사진첩 / 컴퓨터 파일에서 이미지를 선택하면 자동으로 미리보기가 생성됩니다.
            </div>
          </div>

          <div class="form-row">
            <label>이미지 미리보기</label>
            <div id="preview" style="display:flex;gap:6px;flex-wrap:wrap;"></div>
          </div>

          <div style="display:flex; gap:6px; margin-top:8px;">
            <button class="btn-primary" type="button" id="saveBtn">매물 등록</button>
            <button class="btn-secondary" type="button" id="clearBtn">입력 초기화</button>
          </div>
        </div>

        <!-- 회원 보기 -->
        <div class="card" style="margin-top:12px;">
          <div class="card-title" style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
            <div>
              <span>2</span>
              회원 보기
            </div>
            <button class="btn-secondary" type="button" id="loadUsersBtn">회원 목록 불러오기</button>
          </div>
          <div id="userListContainer" class="user-list"></div>
          <div class="help-text" style="margin-top:6px;">
            서버 또는 브라우저에 저장된 회원 정보를 불러와 보여줍니다.
            현재 로그인 중인 회원은 초록색 점으로 표시됩니다.
          </div>
        </div>
      </div>

      <!-- 오른쪽: 등록된 매물 / JSON -->
      <div class="right">
        <!-- 등록된 매물 -->
        <div class="card">
          <div class="card-title">
            <span>3</span>
            등록된 매물
          </div>
          <div id="listContainer" class="list"></div>
          <div class="help-text">
            Hany 부동산 메인 화면(index.html)에서 불러오는 데이터입니다.
          </div>
        </div>

        <!-- JSON 미리보기 / 백업 -->
        <div class="card" style="margin-top:12px;">
          <div class="card-title">
            <span>4</span>
            JSON 미리보기 / 백업
          </div>
          <textarea id="jsonBox" class="json-box" readonly></textarea>
          <div class="help-text">
            문제가 발생했을 때 이 내용을 복사해두면 복구가 수월합니다.
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== 공통 DOM =====
    const titleEl = document.getElementById("title");
    const priceEl = document.getElementById("price");
    const locationEl = document.getElementById("location");
    const mapUrlEl = document.getElementById("mapUrl");
    const descEl = document.getElementById("desc");
    const imagesInput = document.getElementById("images");
    const previewEl = document.getElementById("preview");
    const listContainer = document.getElementById("listContainer");
    const jsonBox = document.getElementById("jsonBox");
    const saveBtn = document.getElementById("saveBtn");
    const clearBtn = document.getElementById("clearBtn");
    const resolveMapBtn = document.getElementById("resolveMapBtn");

    const loadUsersBtn = document.getElementById("loadUsersBtn");
    const userListContainer = document.getElementById("userListContainer");

    const STORAGE_KEY = "hany_listings";

    // ===== 이미지 미리보기 =====
    let currentImages = [];

    function clearPreview() {
      previewEl.innerHTML = "";
      currentImages = [];
    }

    imagesInput.addEventListener("change", () => {
      clearPreview();
      const files = Array.from(imagesInput.files || []);
      if (!files.length) return;

      files.forEach((file) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const url = e.target.result;
          currentImages.push(url);
          const img = document.createElement("img");
          img.src = url;
          img.style.width = "60px";
          img.style.height = "60px";
          img.style.objectFit = "cover";
          img.style.borderRadius = "10px";
          img.style.border = "1px solid #e5e7eb";
          previewEl.appendChild(img);
        };
        reader.readAsDataURL(file);
      });
    });

    // ===== 로컬 저장소 =====
    
    // ===== 매물 캐시 & 서버 동기화 =====
    let listingCache = [];

    function loadListings() {
      return Array.isArray(listingCache) ? listingCache.slice() : [];
    }

    function saveListings(list) {
      listingCache = Array.isArray(list) ? list.slice() : [];
    }

    async function refreshListingsFromServer() {
      try {
        const res = await fetch("/api/listings");
        if (!res.ok) {
          console.error("listings fetch failed", res.status);
          renderList(loadListings());
          return;
        }
        const data = await res.json();
        if (data && data.ok && Array.isArray(data.listings)) {
          saveListings(data.listings);
          const current = loadListings();
          renderList(current);
          if (jsonBox) {
            jsonBox.value = JSON.stringify(current, null, 2);
          }
        } else {
          console.error("listings response invalid", data);
        }
      } catch (e) {
        console.error("refreshListingsFromServer error", e);
      }
    }

    async function createListingOnServer(item) {
      const res = await fetch("/api/listings", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(item),
      });
      return res.json();
    }

    async function deleteListingOnServer(id) {
      const res = await fetch("/api/listings/" + encodeURIComponent(id), {
        method: "DELETE",
      });
      return res.json();
    }

    async function toggleCompleteOnServer(id, completed) {
      const res = await fetch(
        "/api/listings/" + encodeURIComponent(id) + "/complete",
        {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ completed }),
        }
      );
      return res.json();
    }

    // ===== 폼/리스트 처리 =====
 catch (e) {
        console.error(e);
      }
    }

    // ===== 폼/리스트 처리 =====
    function clearForm() {
      titleEl.value = "";
      priceEl.value = "";
      locationEl.value = "";
      mapUrlEl.value = "";
      descEl.value = "";
      imagesInput.value = "";
      clearPreview();
      document
        .querySelectorAll(".tag-group input[type=checkbox]")
        .forEach((el) => (el.checked = false));
    }

    // 구글 지도 짧은 주소 변환
    if (resolveMapBtn && mapUrlEl) {
      resolveMapBtn.addEventListener("click", async () => {
        const shortUrl = mapUrlEl.value.trim();
        if (!shortUrl) {
          alert("먼저 구글 지도 링크를 입력해주세요.");
          return;
        }
        try {
          const res = await fetch("/api/resolve-map?url=" + encodeURIComponent(shortUrl));
          if (!res.ok) {
            alert("주소 변환 요청에 실패했습니다. (서버 응답 없음)");
            return;
          }
          const data = await res.json();
          if (data.fullUrl) {
            mapUrlEl.value = data.fullUrl;
            alert("구글 지도 주소가 변환되었습니다.");
          } else {
            alert(data.error || "주소를 변환하지 못했습니다.");
          }
        } catch (e) {
          console.error(e);
          alert("주소 변환 중 오류가 발생했습니다.");
        }
      });
    }

    
    function renderList(list) {
      listContainer.innerHTML = "";
      if (!list.length) {
        listContainer.innerHTML =
          '<div style="padding:8px 10px;font-size:12px;color:#6b7280;">등록된 매물이 없습니다.</div>';
        if (jsonBox) {
          jsonBox.value = "[]";
        }
        return;
      }

      list.forEach((item) => {
        const li = document.createElement("div");
        li.className = "list-item";

        const tags = (item.tags || []).map((t) => `<span class="badge-tag">${t}</span>`).join("");
        const statusBadge = item.completed
          ? '<span class="badge-tag" style="background:#fee2e2;color:#b91c1c;">계약완료</span>'
          : "";

        li.innerHTML = `
          <div class="list-main">
            <div class="list-title">${item.title || ""}</div>
            <div class="list-sub">
              ${item.location || ""} · ${item.price || ""}
              ${tags} ${statusBadge}
            </div>
          </div>
          <div style="display:flex; gap:4px;">
            <button class="btn-secondary btn-complete" type="button" data-id="${item.id}">
              ${item.completed ? "계약완료 해제" : "계약완료"}
            </button>
            <button class="btn-danger btn-delete" type="button" data-id="${item.id}">삭제</button>
          </div>
        `;

        const delBtn = li.querySelector(".btn-delete");
        const completeBtn = li.querySelector(".btn-complete");

        if (delBtn) {
          delBtn.addEventListener("click", async () => {
            if (!confirm("정말 이 매물을 삭제하시겠습니까?")) return;
            try {
              const res = await deleteListingOnServer(item.id);
              if (!res || !res.ok) {
                alert(res && res.error ? res.error : "매물 삭제에 실패했습니다.");
                return;
              }
              await refreshListingsFromServer();
            } catch (e) {
              console.error(e);
              alert("서버와 통신 중 오류가 발생했습니다.");
            }
          });
        }

        if (completeBtn) {
          completeBtn.addEventListener("click", async () => {
            const targetState = !item.completed;
            try {
              const res = await toggleCompleteOnServer(item.id, targetState);
              if (!res || !res.ok) {
                alert(res && res.error ? res.error : "계약완료 상태 변경에 실패했습니다.");
                return;
              }
              await refreshListingsFromServer();
            } catch (e) {
              console.error(e);
              alert("서버와 통신 중 오류가 발생했습니다.");
            }
          });
        }

        listContainer.appendChild(li);
      });

      if (jsonBox) {
        jsonBox.value = JSON.stringify(list, null, 2);
      }
    }


    
    async function handleSaveListing() {
      const title = titleEl.value.trim();
      const price = priceEl.value.trim();
      const location = locationEl.value.trim();
      const mapUrl = mapUrlEl.value.trim();
      const desc = descEl.value.trim();

      if (!title) {
        alert("제목은 필수입니다.");
        return;
      }

      const tags = Array.from(
        document.querySelectorAll(".tag-group input[type=checkbox]:checked")
      ).map((el) => el.value);

      const item = {
        title,
        price,
        location,
        desc,
        tags,
        mapUrl,
        images: currentImages.slice(),
      };

      try {
        const res = await createListingOnServer(item);
        if (!res || !res.ok) {
          alert(res && res.error ? res.error : "매물 등록에 실패했습니다.");
          return;
        }
        await refreshListingsFromServer();
        alert("매물이 등록되었습니다.");
        clearForm();
      } catch (e) {
        console.error(e);
        alert("서버와 통신 중 오류가 발생했습니다.");
      }
    }


    if (saveBtn) {
      saveBtn.addEventListener("click", handleSaveListing);
    }
    if (clearBtn) {
      clearBtn.addEventListener("click", clearForm);
    }

    // ===== 회원 보기 기능 =====
    function getCurrentUserIdLike() {
      try {
        const infoRaw = localStorage.getItem("hany_current_user_info");
        if (infoRaw) {
          const info = JSON.parse(infoRaw);
          if (info && (info.id || info.nickname)) {
            return info.id || info.nickname;
          }
        }
      } catch (e) {
        console.error(e);
      }
      try {
        const id = localStorage.getItem("hany_current_user");
        if (id) return id;
      } catch (e2) {
        console.error(e2);
      }
      return null;
    }

    function renderUsers(users) {
      if (!userListContainer) return;
      userListContainer.innerHTML = "";
      if (!users || !users.length) {
        userListContainer.innerHTML =
          '<div style="font-size:12px;color:#777;">등록된 회원이 없습니다.</div>';
        return;
      }
      const currentIdLike = getCurrentUserIdLike();

      users.forEach((u) => {
        const div = document.createElement("div");
        div.className = "user-item";

        let isCurrent = false;
        if (currentIdLike) {
          if (u.id === currentIdLike || u.nickname === currentIdLike) {
            isCurrent = true;
          }
        }

        const roleLabel = u.role === "admin" ? "관리자" : "회원";
        const phoneText = u.phone ? u.phone : "전화번호 미입력";

        div.innerHTML =
          '<div class="user-main">' +
          '<div class="user-name-row">' +
          '<span class="user-name">' +
          (u.nickname || u.id || "") +
          "</span>" +
          '<span class="user-role-badge">' +
          roleLabel +
          "</span>" +
          "</div>" +
          '<div class="user-meta">ID: ' +
          (u.id || "-") +
          " · " +
          phoneText +
          "</div>" +
          "</div>" +
          '<div class="user-item-right">' +
          (isCurrent
            ? '<span class="current-indicator"></span><span>현재 로그인</span>'
            : "") +
          "</div>";

        userListContainer.appendChild(div);
      });
    }

    async function fetchUsersFromServer() {
      try {
        const res = await fetch("/api/users", { method: "GET" });
        if (!res.ok) {
          return { error: "서버에서 회원 목록 API(/api/users)를 찾을 수 없습니다." };
        }
        const data = await res.json();
        if (data && data.ok && Array.isArray(data.users)) {
          return { users: data.users };
        }
        return { error: data && data.error ? data.error : "회원 목록 응답 형식이 올바르지 않습니다." };
      } catch (e) {
        console.error(e);
        return { error: "서버 요청 중 오류가 발생했습니다." };
      }
    }

    function loadUsersFromLocal() {
      try {
        const raw = localStorage.getItem("hany_users");
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : [];
      } catch (e) {
        console.error(e);
        return [];
      }
    }

    async function handleLoadUsers() {
      if (!userListContainer) return;
      userListContainer.innerHTML =
        '<div style="font-size:12px;color:#777;">불러오는 중...</div>';

      // 1) 서버에서 먼저 시도
      const result = await fetchUsersFromServer();
      if (result && result.users) {
        renderUsers(result.users);
        return;
      }

      // 2) 서버 실패 시 localStorage로 fallback
      const localUsers = loadUsersFromLocal();
      if (localUsers.length) {
        renderUsers(localUsers);
        alert("서버에서 회원 목록을 가져오지 못해, 브라우저에 저장된 회원 목록을 대신 표시합니다.");
        return;
      }

      userListContainer.innerHTML =
        '<div style="font-size:12px;color:#777;">등록된 회원이 없습니다.</div>';
      if (result && result.error) {
        alert(result.error);
      } else {
        alert("회원 목록을 가져오지 못했습니다.");
      }
    }

    if (loadUsersBtn) {
      loadUsersBtn.addEventListener("click", handleLoadUsers);
    }

    // ===== 초기 렌더 =====
    refreshListingsFromServer();
  </script>
</body>
</html>
